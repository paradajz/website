<!DOCTYPE html> <html lang="zxx"> <head> <!-- meta --> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width,initial-scale=1"> <meta name="description" content=""> <meta name="keywords" content=""> <!-- Facebook Open Graph --> <meta content="Shantea Controls" property="og:site_name"> <meta property="og:locale" content="en_US"> <meta content="Assumptions" property="og:title"> <meta content="article" property="og:type"> <meta content="" property="og:description"> <meta content="https://shanteacontrols.com/2014/12/02/assumptions/" property="og:url"> <meta content="" property="og:image"> <meta content="programming" property="article:tag"> <meta content="2014-12-02T00:00:00+00:00" property="article:published_time"> <!-- Twitter cards --> <meta name="twitter:site" content="@"> <meta name="twitter:creator" content="@"> <meta name="twitter:title" content="Assumptions"> <meta name="twitter:description" content=""> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content=""> <!-- Site Title --> <title> Assumptions &#8226 Shantea Controls Blog </title> <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon"> <!-- gulp:css --> <link rel="stylesheet" href="/css/blog/app.css"> <!-- endgulp --> <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600" rel="stylesheet"> </head> <nav class="navbar navbar-default fixed-top"> <div class="container-fluid"> <div class="navbar-header"> <a href="/blog/blog.html"> <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" fill="currentColor" class="bi bi-house" viewBox="0 0 16 16"> <path fill-rule="evenodd" d="M2 13.5V7h1v6.5a.5.5 0 0 0 .5.5h9a.5.5 0 0 0 .5-.5V7h1v6.5a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 13.5zm11-11V6l-2-2V2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5z"/> <path fill-rule="evenodd" d="M7.293 1.5a1 1 0 0 1 1.414 0l6.647 6.646a.5.5 0 0 1-.708.708L8 2.207 1.354 8.854a.5.5 0 1 1-.708-.708L7.293 1.5z"/> </svg> </a> <a href="/pages/tags/"> <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" fill="currentColor" class="bi bi-hash" viewBox="0 0 16 16"> <path d="M8.39 12.648a1.32 1.32 0 0 0-.015.18c0 .305.21.508.5.508.266 0 .492-.172.555-.477l.554-2.703h1.204c.421 0 .617-.234.617-.547 0-.312-.188-.53-.617-.53h-.985l.516-2.524h1.265c.43 0 .618-.227.618-.547 0-.313-.188-.524-.618-.524h-1.046l.476-2.304a1.06 1.06 0 0 0 .016-.164.51.51 0 0 0-.516-.516.54.54 0 0 0-.539.43l-.523 2.554H7.617l.477-2.304c.008-.04.015-.118.015-.164a.512.512 0 0 0-.523-.516.539.539 0 0 0-.531.43L6.53 5.484H5.414c-.43 0-.617.22-.617.532 0 .312.187.539.617.539h.906l-.515 2.523H4.609c-.421 0-.609.219-.609.531 0 .313.188.547.61.547h.976l-.516 2.492c-.008.04-.015.125-.015.18 0 .305.21.508.5.508.265 0 .492-.172.554-.477l.555-2.703h2.242l-.515 2.492zm-1-6.109h2.266l-.515 2.563H6.859l.532-2.563z"/> </svg> </a>  </div> </div> </nav> <body class="post-template"> <div class="page-header grey-bg mt-5 pb-100 mb-100 pt-85 clearfix"> <div class="container"> <div class="row"> <div class="col"> <div class="author-text"> <div class="single-author-d w-100"> <div class="title"> <h2 class="mb-0 text-center">Assumptions</h2> </div> <div class="post-meta d-flex"> <ul class="post-sp-meta list-inline mx-auto my-0"> <li class="list-inline-item"> <i class="fa fa-clock-o"></i>02 December 2014 </li> </ul> </div> </div> </div> </div> </div> </div> </div> <div class="post-content-area pb-100 clearfix"> <div class="container"> <div class="row"> <div class="col-lg-10 mx-auto"> <div class="s-post-details"> <div class="entry-content"><p>In this post, I’m going to talk about collection of libraries that make up the OpenDeck platform, and why it’s important to really understand your code well.</p> <h2 id="arduino">Arduino</h2> <p>Before I start talking about Ownduino, I want to clarify what Arduino really is. Basically, it is an Atmel AVR microcontroller placed on a nice PCB with pin headers, combined with libraries that make the programming those chips so much easier, hiding away all the scary parts of embedded programming from user. Once you start dwelling into source code of most of the functions, you’ll find out that most of them have dozens of lines of code for performing really simple tasks, like reading the pins. But that is understandable, it’s the price you pay for convenience. After all, Arduino was never designed to give you the most of its hardware, it was designed to get you into the world of embedded programming really fast. What is not understandable is that most of Arduino code is really bad. Much of the code even goes against recommended approaches in Atmel ATmega datasheet, just take a look at serial functions. There is also a case of enabling many things by default, including lots of unnecessary code you don’t need most of the time. ‘You can’t manage something you can’t control’ is a nice thing I learned this year in college, and it applies perfectly here. Since I wanted to be in complete control over the code that runs on my platform, I created something called Ownduino. Not that creative name, but whatever.</p> <h2 id="ownduino">Ownduino</h2> <p>Ownduino is a lightweight library which contains only few of most used functions from Arduino, like Serial.begin(), Serial.write(), millis() and a couple more functions. Ownduino also gives user a choice to completely disable ADC, timer or Serial buffer. digitalRead, digitalWrite or String class are examples of what you will not find in Ownduino.</p> <h2 id="midi-library">MIDI library</h2> <p>For OpenDeck project I’m using modified Arduino MIDI library v3.2. I realize there is newer version available, but this one has worked flawlessly so far, and I don’t see that changing any time soon. However, I did modify it to more suit my needs. That’s the beauty of open source. Of course, all of the changes I made are published under OpenDeck GitHub repository. Most of the changes were pretty minor, like removing stuff I don’t need, and adding a option to enable or disable MIDI running status via MIDI System Exclusive.</p> <h3 id="midi-running-status-issues">MIDI running status issues</h3> <p>I do very little testing with <a href="http://www.altmustech.com/au-123.html">Altmustech AU-123</a> MIDI chip, since I’m only using it in finished products (controllers I sell). Because of that, I recently run into some issues when enabling MIDI running status by default. Running status is great in theory, you can read more about it <a href="http://www.blitter.com/~russtopia/MIDI/~jglatt/tech/midispec/run.htm">here</a>. However, most MIDI equipment still has issues with it, and it’s best to leave it disabled if unsure what to do. Anyways, MIDI chip I’m using started to misbehave when I enabled it, and it really took me a while before I figured what was wrong, because the same code worked without issues when using serial to MIDI conversions. Reason why this didn’t work is because USB MIDI actually prohibits running status - I didn’t know about that until this had happened. Lesson: never assume things will work. If they do, then there is most likely something wrong. It’s the only constant in universe.</p> <h3 id="system-exclusive">System Exclusive</h3> <p>Now this is a major issue, also discovered recently. It turned out that MIDI chip I’m using doesn’t really support MIDI SysEx, which means that with current OpenDeck setup, you are unable to configure anything using AU-123 - the core platform feature! Chip actually pretends it supports SysEx; it will gladly forward SysEx start and first byte after it, but it will also gladly ignore anything after first data byte, which renders its SysEx ‘support’ unusable. Not all is lost, however. I can still configure controller in emulated environment (virtual MIDI cable + HairlessMIDI + MIDI-OX), and because of this, I’m moving away from current ATmega328P setup to Arduino Pro Micro, with Atmega32u4 on it, which has USB support, so I can get rid of separate MIDI board.</p> <h2 id="code-optimizations">Code optimizations</h2> <p>Recently, I’ve discovered that I can send real time MIDI data from Traktor Pro to a MIDI controller. MIDI data in question is track volume. You can send volume data to controller to turn the LEDs on and off, resulting in VU-meter. The problem with previous version of OpenDeck was that code was too slow. Code used too much time to read the potentiometers, which affected timing of column switching inside matrix and reading of MIDI input. Result of all that was that code was unable to catch all incoming MIDI data, so some LEDs would’ve stayed on when they don’t need to be, and vice versa.</p> <h3 id="time-interrupts">Time interrupts</h3> <p>Thing I learned from this is that matrix switching should always be done inside a interrupt routine. It’s the only way of ensuring correct switching without any delays. <a href="https://github.com/shanteacontrols/OpenDeck/blob/master/lib/OpenDeck/HardwareControl.cpp#L324">Placing matrix switching inside interrupt routine</a> was first thing I did to optimize the code. Second thing again boils down to knowing your code, something Arduino hides away from you.</p> <h3 id="adc-configuration">ADC configuration</h3> <p>In order to explain what I did, it’s necessary to understand how ADC inside ATmega works. When converting analog signal to digital one, ATmega takes samples of input signal at a certain speed, derived from microcontroller clock sped (16MHz). In order to control this speed, there are couple of prescalers available (ATmega328p datasheet, page 256):</p> <p><img src="/images/blog/screenshot086.png" alt=""></p> <p>By default, Arduino uses prescaler 128, which means it runs at 125kHz. Since single ADC conversion takes 13 cycles, that gives us a sample rate of 9.6kHz. Note however, that pushing the ADC clock up to 1MHz doesn’t have much of an influence on 8-bit values, and since MIDI requires 7-bit resolution, there is no reason not to exactly that, that is, to set the prescaler to 32, giving us a sample rate of 38kHz, much faster than the default. Because of this, I included a setADCprescaler function inside Ownduino, to make it easier for me:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>void setADCprescaler(uint8_t prescaler)
{
    //disable ADC before setting new prescaler ADCSRA &amp;= (0&lt;&lt;ADEN);
    switch(prescaler)
    {
        case 16:
        ADCSRA |= (1&lt;&lt;ADPS2)|(1&lt;&lt;ADEN);
        break;

        case 32:
        ADCSRA |= (1&lt;&lt;ADPS2)|(1&lt;&lt;ADPS0)|(1&lt;&lt;ADEN);
        break;

        case 64:
        ADCSRA |= (1&lt;&lt;ADPS2)|(1&lt;&lt;ADPS1)|(1&lt;&lt;ADEN);
        break;

        case 128:
        default: ADCSRA |= (1&lt;&lt;ADPS2)|(1&lt;&lt;ADPS1)|(1&lt;&lt;ADPS0)|(1&lt;&lt;ADEN);
        break;
    }
}
</code></pre></div></div> <p>Now, we get much faster analog read-out, and 8-bit precision. If you consider that ATmega328P has 10-bit ADC, and that ATmega328P is 8-bit microcontroller, ADC value is obviously stored inside two registers: ADCH (2 higher bits) and ADCL (8 lower bits). We can easily discard two bits, so that we need only one register. To do this, we can invert places where ADC value is stored by using this line:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ADMUX |= (1&lt;&lt;ADLAR);
</code></pre></div></div> <p>Now, analog value is in the range 0-255, and when reading the value, we simply read ADCH register, eliminating the need to read extra register. Divide it by two, and we get nice 7-bit value required for MIDI.</p> <h2 id="conclusion">Conclusion</h2> <p>Together with doing matrix switching inside timer interrupt, code now performs much faster, and there are no more problems with sending lots of data to controller. You can check out VU-meter in action here:</p> <div class="videoWrapper"> <iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/0UBKplDQOXQ" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe> </div> <p>So, in short:</p> <ol> <li>Never assume anything</li> <li>Know your code</li> </ol> <p>That would be all.</p> </div> <div class="inner-padding fullwidth pb-60"> <div class="post-share-icon clearfix"> <div class="tag-list"> <div class="row"> <div class="col-md-8"> <p class="float-left pr-2"><strong>Tags :</strong></p> <ul class="float-left"> <li> <a href="/tag/programming/blog.html"> #programming</a> </li> </ul> </div> <div class="col-md-4"></div> </div> </div> </div> </div> </div> <div class="categories-carousel pb-60 clearfix"> <div class="section-title"> <h3>Related Posts</h3> </div> <div class="related-post-carousel owl-carousel"> <div class="single-item"> <div class="categories-post-image"> <div class="categories-post-hover text-center"> <div class="hover-details"> <div class="post-link"> <h3> <a href="/2020/06/11/creating-custom-opendeck-board-variants/">Creating custom OpenDeck board variants</a> </h3> <div class="btn-read"> <a href="/2020/06/11/creating-custom-opendeck-board-variants/">Read More</a> </div> </div> </div> </div> </div> </div> <div class="single-item"> <div class="categories-post-image"> <div class="categories-post-hover text-center"> <div class="hover-details"> <div class="post-link"> <h3> <a href="/2019/06/21/opendeck-v4-0-0-whats-new/">OpenDeck software v4.0.0 - What's new?</a> </h3> <div class="btn-read"> <a href="/2019/06/21/opendeck-v4-0-0-whats-new/">Read More</a> </div> </div> </div> </div> </div> </div> <div class="single-item"> <div class="categories-post-image"> <img src="/images/blog/43b3a-presets_global.png" alt="OpenDeck software v3.1.0 - Presets"> <div class="categories-post-hover text-center"> <div class="hover-details"> <div class="post-link"> <h3> <a href="/2018/11/19/opendeck-sw-v3-1-0-presets/">OpenDeck software v3.1.0 - Presets</a> </h3> <div class="btn-read"> <a href="/2018/11/19/opendeck-sw-v3-1-0-presets/">Read More</a> </div> </div> </div> </div> </div> </div> <div class="single-item"> <div class="categories-post-image"> <img src="/images/blog/wp_20150224_0281.jpg" alt="Building Ceylon"> <div class="categories-post-hover text-center"> <div class="hover-details"> <div class="post-link"> <h3> <a href="/2015/02/24/building-ceylon/">Building Ceylon</a> </h3> <div class="btn-read"> <a href="/2015/02/24/building-ceylon/">Read More</a> </div> </div> </div> </div> </div> </div> <div class="single-item"> <div class="categories-post-image"> <div class="categories-post-hover text-center"> <div class="hover-details"> <div class="post-link"> <h3> <a href="/2014/10/09/opendeck-sysex-protocol-stable/">OpenDeck SysEx protocol - stable!</a> </h3> <div class="btn-read"> <a href="/2014/10/09/opendeck-sysex-protocol-stable/">Read More</a> </div> </div> </div> </div> </div> </div> <div class="single-item"> <div class="categories-post-image"> <div class="categories-post-hover text-center"> <div class="hover-details"> <div class="post-link"> <h3> <a href="/2014/08/30/building-opendeck-sysex-protocol/">Building OpenDeck - SysEx protocol</a> </h3> <div class="btn-read"> <a href="/2014/08/30/building-opendeck-sysex-protocol/">Read More</a> </div> </div> </div> </div> </div> </div> </div> </div> </div> </div> </div> </div> <footer> <div class="footer-area clearfix"> <div class="container"> <div class="row"> <div class="col-lg-12"> <div class="footer-logo pb-100 pt-100 text-center"> <a href="https://shanteacontrols.com"> <img src="/images/logo_notext_inv.svg" alt="Shantea Controls"> </a> </div> </div> </div> <div class="row pb-60"> <div class="col-lg-3 col-md-6"> <div class="footer-widget"> <div class="widget-title"> <h4> About </h4> </div> <div class="widget-text"> <p>Shantea Controls Blog</p> <div class="social-link"> <ul> </ul> </div> </div> </div> </div> <div class="col-lg-3 col-md-6"> <div class="footer-widget"> <div class="widget-title"> <h4>Recent posts</h4> </div> <div class="widget-text"> <div class="r-post"> <ul> <li><a href="/2022/06/24/new-pco-features/">Using The New Program Change Offset Features In OpenDeck v7.3.0 </a> </li> <li><a href="/2022/06/20/opendeck-boards-v3-available-now/">OpenDeck boards v3 now available </a> </li> <li><a href="/2022/04/09/opendeck-boards-v3-in-development/">OpenDeck boards v3 in development </a> </li> <li><a href="/2022/04/09/opendeck-7/">OpenDeck v7 </a> </li> </ul> </div> </div> </div> </div> <div class="col-lg-3 col-md-6"> <div class="footer-widget"> <div class="widget-title"> <h4> Links</h4> </div> <div class="widget-text"> <div class="widget-link"> <ul> <ul> <li><a href="/" target="_blank">Main page</a></li> <li><a href="https://youtube.com/shanteacontrols" target="_blank">YouTube</a></li> <li><a href="https://www.facebook.com/shanteacontrolsmidi" target="_blank">Facebook</a></li> <li><a href="https://github.com/shanteacontrols/OpenDeck" target="_blank">GitHub</a></li> </ul> </ul></div> </div> </div> </div> </div> <div class="row"> <div class="col"> <div class="footer-text text-center"> <p class="footer-address"> &copy; 2024 Shantea Controls | Developed by <a href="https://themeix.com">themeix</a></p> </div> </div> </div> </div> </div> </footer> <script src="/js/blog/build.js"></script> </body> </html> 