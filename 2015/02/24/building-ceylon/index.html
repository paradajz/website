<!DOCTYPE html> <html lang="zxx"> <head> <!-- meta --> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width,initial-scale=1"> <meta name="description" content=""> <meta name="keywords" content=""> <!-- Facebook Open Graph --> <meta content="Shantea Controls" property="og:site_name"> <meta property="og:locale" content="en_US"> <meta content="Building Ceylon" property="og:title"> <meta content="article" property="og:type"> <meta content="" property="og:description"> <meta content="https://shanteacontrols.com/2015/02/24/building-ceylon/" property="og:url"> <meta content="wp_20150224_0281.jpg" property="og:image"> <meta content="ceylon" property="article:tag"> <meta content="buildlog" property="article:tag"> <meta content="programming" property="article:tag"> <meta content="2015-02-24T00:00:00+00:00" property="article:published_time"> <!-- Twitter cards --> <meta name="twitter:site" content="@"> <meta name="twitter:creator" content="@"> <meta name="twitter:title" content="Building Ceylon"> <meta name="twitter:description" content=""> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:image" content="https://shanteacontrols.comwp_20150224_0281.jpg"> <!-- Site Title --> <title> Building Ceylon &#8226 Shantea Controls Blog </title> <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon"> <!-- gulp:css --> <link rel="stylesheet" href="/css/blog/app.css"> <!-- endgulp --> <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600" rel="stylesheet"> </head> <nav class="navbar navbar-default fixed-top"> <div class="container-fluid"> <div class="navbar-header"> <a href="/blog/blog.html"> <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" fill="currentColor" class="bi bi-house" viewBox="0 0 16 16"> <path fill-rule="evenodd" d="M2 13.5V7h1v6.5a.5.5 0 0 0 .5.5h9a.5.5 0 0 0 .5-.5V7h1v6.5a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 13.5zm11-11V6l-2-2V2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5z"/> <path fill-rule="evenodd" d="M7.293 1.5a1 1 0 0 1 1.414 0l6.647 6.646a.5.5 0 0 1-.708.708L8 2.207 1.354 8.854a.5.5 0 1 1-.708-.708L7.293 1.5z"/> </svg> </a> <a href="/pages/tags/"> <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" fill="currentColor" class="bi bi-hash" viewBox="0 0 16 16"> <path d="M8.39 12.648a1.32 1.32 0 0 0-.015.18c0 .305.21.508.5.508.266 0 .492-.172.555-.477l.554-2.703h1.204c.421 0 .617-.234.617-.547 0-.312-.188-.53-.617-.53h-.985l.516-2.524h1.265c.43 0 .618-.227.618-.547 0-.313-.188-.524-.618-.524h-1.046l.476-2.304a1.06 1.06 0 0 0 .016-.164.51.51 0 0 0-.516-.516.54.54 0 0 0-.539.43l-.523 2.554H7.617l.477-2.304c.008-.04.015-.118.015-.164a.512.512 0 0 0-.523-.516.539.539 0 0 0-.531.43L6.53 5.484H5.414c-.43 0-.617.22-.617.532 0 .312.187.539.617.539h.906l-.515 2.523H4.609c-.421 0-.609.219-.609.531 0 .313.188.547.61.547h.976l-.516 2.492c-.008.04-.015.125-.015.18 0 .305.21.508.5.508.265 0 .492-.172.554-.477l.555-2.703h2.242l-.515 2.492zm-1-6.109h2.266l-.515 2.563H6.859l.532-2.563z"/> </svg> </a>  </div> </div> </nav> <body class="post-template"> <div class="page-header grey-bg mt-5 pb-100 mb-100 pt-85 clearfix"> <div class="container"> <div class="row"> <div class="col"> <div class="author-text"> <div class="single-author-d w-100"> <div class="title"> <h2 class="mb-0 text-center">Building Ceylon</h2> </div> <div class="post-meta d-flex"> <ul class="post-sp-meta list-inline mx-auto my-0"> <li class="list-inline-item"> <i class="fa fa-clock-o"></i>24 February 2015 </li> </ul> </div> </div> </div> </div> </div> </div> </div> <div class="post-content-area pb-100 clearfix"> <div class="container"> <div class="row"> <div class="col-lg-10 mx-auto"> <div class="s-post-details"> <div class="post-image mb-4"> <img class="mx-auto d-block" src="/images/blog/wp_20150224_0281.jpg" alt="Building Ceylon"> </div> <div class="entry-content"><p>This is a long overdue post about Ceylon, another Shantea Controls controller, only this time, one that I’ve built for myself. Of course, it’s based on OpenDeck platform.</p> <p>Ceylon was actually built about three months ago. Reason why I haven’t written about it is a combination of things really. First, it was in a beta period for more than a month, and after that I just didn’t have much time to write posts, as I was really busy (and still am) with other projects that I’ll hopefully write about soon.</p> <h2 id="name-and-design">Name and design</h2> <p>Let’s start with a name. After Anandamidi and Sensimidia, it was time to bring back tea in Shantea Controls again. So, Ceylon is actually well-known high-quality tea originating from Sri Lanka, former British colony known as Ceylon (hence the name). There are couple of variations of it, black one being my favorite (with some spices of course, that is, loads of ginger).</p> <p><img src="/images/blog/10678704_306345016225412_2880265286737813749_n.jpg" alt=""></p> <p>Picture above is a rendered drawing of Ceylon design. Numbers around the circle are coordinates of Kandy District, heartland of tea production in Sri Lanka. So there you have it, a Ceylon story!</p> <h2 id="layout">Layout</h2> <p>Since <a href="https://www.youtube.com/watch?v=EUA4rHStOaI">Tannin</a> was my only controller so far, I’ve mapped nearly every function I need, so when I started designing my second controller, I wanted something really simple that would complement Tannin well. There was no need for a complicated layout or redundant functions, that’s why its design is really minimal. There are 3 faders, 12 orange LEDs for some eye-candy, err, I mean VU-meter, shift button, two potentiometers above faders for gain control, six anti-vandal switches with blue LEDs, and disk. Most significant change here from Tannin is the use of encoder. Well, not your usual encoder though. It’s a salvaged HDD motor acting to be encoder actually.</p> <h2 id="plate">Plate</h2> <p>Ceylon is first controller I’ve built which doesn’t use standard black/white Gravoply plate, as I grew tired of it. Instead, I’ve picked blue plate this time, and it looks really gorgeous.</p> <p><img src="/images/blog/wp_20150224_0281.jpg" alt=""></p> <p>I also redesigned USB plate.</p> <p><img src="/images/blog/wp_20150224_0171.jpg" alt=""></p> <p>Case is white again, just like Tannin.</p> <h2 id="the-disk">The disk</h2> <p>As I’ve already stated, only thing new in Ceylon is the disk. So, how does it work? The motor in mechanical hard disk generates phase-shifted sinusoidal waveforms when spinned. The faster you spin it, larger the amplitude and frequency of waveforms. By examing waveforms, you can determine disk direction, which is what I needed. There are couple of issues with this:</p> <ol> <li> <p>Signal amplitude is way too low to be sampled directly by a microcontroller, unless you spin the disk real fast, which is kind of missing the point of whole setup as you want fine grained control. My measurements showed that disk generates +-500mV when spinned at maximum speed (maximum being somewhat subjective term, I spinned it by hand).</p> </li> <li> <p>For encoders, you don’t actually need analog signals, but digital ones. By examining output data from two encoder pins, you can easily determine its direction. Those two outputs are called quadrature outputs, as they are 90 degrees out of phase.</p> </li> </ol> <p><img src="/images/blog/600px-quadrature_diagram-svg.png" alt=""></p> <p><img src="/images/blog/screenshot209.png" alt=""></p> <h3 id="making-the-signals-digital">Making the signals digital</h3> <p>Basically, what this setup needed was ADC (analog-to-digital converter). For this use, I’ve chosen <a href="http://www.ti.com/lit/ds/symlink/lm339-n.pdf">LM339</a>, a very cheap, available and popular comparator. LM339 contains four comparators in a package, making it suitable for this setup, as I needed only two. Comparator takes two inputs, and simply determines which one is bigger. If voltage on non-inverting input (+) is larger than voltage on inverting input (-), output is digital 1, or Vcc, and if non-inverting input is smaller than inverting input, output is digital 0, or -Vcc (in this case GND). Very simple. But as usual, there are couple of caveats.</p> <p>Connecting motor inputs directly to LM339 isn’t such a good idea, for two reasons:</p> <ol> <li>What happens if two signals are very close to each other? Comparator would output bunch of ones and zeros very fast, which is actually junk, so you get unreliable results.</li> <li>According to LM339 datasheet, you cannot apply more than -0.3V at either of its inputs. This is a problem, as disk actually outputs about -0.5V when spinned real fast.</li> </ol> <h4 id="hysteresis">Hysteresis</h4> <p>It took me really long to figure out what hysteresis actually is, but it’s actually really simple. Using hysteresis on comparator, you are creating two thresholds for generating two output states, that is, you are setting one threshold for output to be Vcc, and second one to be -Vcc, that is GND. This is achived by applying positive feedback from output back to input, using two resistors. Since signal from motor is really low, I’ve designed hysteresis for low values, just to keep signal from circling around switch point. Hysteresis is calculated using this formula:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Vth+ = -VN * (R1 / R2)
Vth-  = -VP * (R1 / R2)
</code></pre></div></div> <p>Vth is threshold voltage, Vn is negative output (in this case 0V), and Vp is positive output (+5V in this case). I wanted to set positive threshold above 0V, and negative below -5mV, so resistor values are 1k for R1, and 1M for R2:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Vth+ = -0 * (1000/1000000)
Vth+ = 0V
Vth- = -5 * (1000/1000000)
Vth- = -5mV
</code></pre></div></div> <p>So, when positive input voltage is above 0V, output is 1, and only when negative input drops below -5mV, output is 0. This way I created “dead zone”, or area where my signal can be of any value (between 0 and -5mV), without affecting the output of comparator.</p> <p><img src="/images/blog/250px-smitt_hysteresis_graph-svg.png" alt=""></p> <p>Graph is showing the input signal (U), usage of comparator on that signal without hysteresis (A), and output signal from comparator with applied hysteresis (B).</p> <p><img src="/images/blog/2000px-op-amp_schmitt_trigger-svg.png" alt=""></p> <p>Picture above shows hysteresis setup. This is how you debounce your inputs using hysteresis, so that your output never becomes gibberish.</p> <h4 id="voltage-clipping">Voltage clipping</h4> <p>Now, there is one more concern. As I stated already, inputs on LM339 cannot be smaller than -0.3V. To accommodate this, I used BAT46 Schottky diode on inputs, having anode connected to ground. When the input is positive, diode doesn’t do anything as current cannot pass through. When the input is negative, diode still won’t do anything, as long as input voltage doesn’t become smaller than -0.3V. Those diodes have a voltage drop of about 0.3V (how convenient), so, when input voltage exceeds -0.3V, current will pass through diode, and voltage on comparator input will actually be voltage drop on that diode, and it will not exceed those -0.3V. Two problems solved, yay!</p> <p><img src="/images/blog/encoder.png" alt=""></p> <h3 id="software-side-of-things">Software side of things</h3> <p>Now that I’ve taken care of hardware, it was time to actually read and process signals from motor. For this, I’ve used modified <a href="https://www.pjrc.com/teensy/td_libs_Encoder.html">encoder library</a> for Teensy/Arduino. Library is great as it has two really clever parts:</p> <ol> <li> <p>Since it’s written with Teensy/Arduino in mind, it automatically detects whether the pins on your microcontroller on which you’ve connected encoder have interrupt capability. If they do, library reads encoder using interrupts. Since HDD motor can be spinned real fast, I’ve connected both motor pins to interrupts (pins 2/3 on Arduino) in order not to miss any pulse. Pins 2 and 3 are two out of four unused pins on my OpenDeck board, so this was very convenient.</p> </li> <li> <p>It has “predicting” algorithm, giving your encoder 4x more resolution. This is achieved by remembering previous state of pins, and comparing it to current state of pins with a lookup table. Lookup table contains valid encoder transitions:</p> </li> </ol> <p><img src="/images/blog/screenshot210.png" alt=""></p> <p>This works really, really well, but since HDD motor jumped a bit when changing direction, I’ve implemented additional debouncing:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>void OpenDeck::readEncoders(int32_t encoderPosition)
{
    if (_board == SYS_EX_BOARD_TYPE_OPEN_DECK_1)
    {
        if (encoderPosition != oldPosition)
        {
            if (millis() - lastSpinTime &gt; ENCODER_DEBOUNCE_TIME)
              initialDebounceCounter = 0;

            if (encoderPosition &gt; oldPosition)
            {
                if (!direction)
                {
                    initialDebounceCounter = 0;
                    direction = true;
                }

                if (initialDebounceCounter &gt;= ENC_STABLE_AFTER)
                  sendPotCCDataCallback(127, 127, 5);
                else
                  initialDebounceCounter++;
            }
            else if (encoderPosition &lt; oldPosition)
            {
                if (direction)
                {
                    initialDebounceCounter = 0;
                    direction = false;
                }

                initialDebounceCounter++;

                if (initialDebounceCounter &gt;= ENC_STABLE_AFTER)
                    sendPotCCDataCallback(127, 1, 5);
                else
                    initialDebounceCounter++;
            }

            oldPosition = encoderPosition;
            lastSpinTime = millis();
        }
    }
}
</code></pre></div></div> <p>If there is a movement detected, code first checks for whether the disk hasn’t been moved for more than <code class="language-plaintext highlighter-rouge">ENCODER_DEBOUNCE_TIME</code> (70mS). If it hasn’t, it resets the debounce counter. This is to avoid extra pulses when disk is slowing down. After that, initialDebounceCounter variable is incremented until it reaches 1. This is to prevent disk jumping when changing direction.</p> <p>So there you have it, a pretty good resolution from HDD motor for use in MIDI controller! In all honesty, its resolution is far from optical encoders, but as this is more of a proof-of-concept, I’m really satisfied with results.</p> <h2 id="leds-on-anti-vandal-switches">LEDs on anti-vandal switches</h2> <p>This was another issue that I had while building Ceylon. Anti vandal switches (the ones around the disk) I had around have blue LED on them. Their pins are separated from button pins. Those button pins can be connected in NC and NO configuration, so there’s 5 pins in total. Since I’m using shared column button/LED matrix in my OpenDeck platform, I’ve connected - pin of LED and one of button pins together, going into same column, and then + pin of LED into LED row, and second button pin to button row. Nothing out of ordinary, right? Well, something weird was happening with this setup. Whenever I pressed the button, LED on it lighted up. This is not the behavior that I expected nor wanted, so for a while I had no idea what was happening. Only few days later, I’ve discovered that it doesn’t really matter where you connect + and - of the integrated LED on button, since there are 2 LEDs inside, one of which has anode on + pin, and second one on - pin.</p> <p><img src="/images/blog/anti-vandal-configuration.png" alt=""></p> <p>Okay, but why does the LED turn on when button is pressed? For this, answer is in matrix setup. LED/button matrix works by switching columns very rapidly. Only one column is active at the time, and during that time, it is connected to GND, while others are connected to Vcc. When button is pressed, connection from microcontroller input on which button is connected goes to GND, and button press is registered, but only during the time the column is active. When column isn’t active anymore, it’s connected to Vcc. Since those switches have two LEDs inside, one of which has anode on - pin, when button is pressed, and column isn’t active, that anode is actually connected to Vcc, and LED row on microcontroller starts acting like current sink, so LED is lighted up.</p> <p><img src="/images/blog/switch1.png" alt=""></p> <p>In order to solve this, I’ve placed Schottky diode (to minimize voltage drop) between LED anodes and microcontroller LED row pin, so that the current is blocked for second LED inside switches.</p> <p><img src="/images/blog/switch2.png" alt=""></p> <h2 id="demo">Demo</h2> <p>So, to conclude this post, here’s a short video of Ceylon in action, together with Tannin.</p> <div class="videoWrapper"> <iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/ObLED808kKk" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe> </div> <p>And also some higher quality pictures of Ceylon.</p> <p><img src="/images/blog/img_8565.jpg" alt=""></p> <p>Thanks for reading!</p> </div> <div class="inner-padding fullwidth pb-60"> <div class="post-share-icon clearfix"> <div class="tag-list"> <div class="row"> <div class="col-md-8"> <p class="float-left pr-2"><strong>Tags :</strong></p> <ul class="float-left"> <li> <a href="/tag/ceylon/blog.html"> #ceylon</a> </li> <li> <a href="/tag/buildlog/blog.html"> #buildlog</a> </li> <li> <a href="/tag/programming/blog.html"> #programming</a> </li> </ul> </div> <div class="col-md-4"></div> </div> </div> </div> </div> </div> <div class="categories-carousel pb-60 clearfix"> <div class="section-title"> <h3>Related Posts</h3> </div> <div class="related-post-carousel owl-carousel"> <div class="single-item"> <div class="categories-post-image"> <img src="/images/blog/193474182_259492185848862_7612030630368761512_n.jpg" alt="The new DubFocus controller"> <div class="categories-post-hover text-center"> <div class="hover-details"> <div class="post-link"> <h3> <a href="/2021/06/04/the-new-dubfocus-controller/">The new DubFocus controller</a> </h3> <div class="btn-read"> <a href="/2021/06/04/the-new-dubfocus-controller/">Read More</a> </div> </div> </div> </div> </div> </div> <div class="single-item"> <div class="categories-post-image"> <img src="/images/blog/touchscreen_trio.jpg" alt="The touchscreen trio"> <div class="categories-post-hover text-center"> <div class="hover-details"> <div class="post-link"> <h3> <a href="/2021/02/18/the-touchscreen-trio/">The touchscreen trio</a> </h3> <div class="btn-read"> <a href="/2021/02/18/the-touchscreen-trio/">Read More</a> </div> </div> </div> </div> </div> </div> <div class="single-item"> <div class="categories-post-image"> <div class="categories-post-hover text-center"> <div class="hover-details"> <div class="post-link"> <h3> <a href="/2020/06/11/creating-custom-opendeck-board-variants/">Creating custom OpenDeck board variants</a> </h3> <div class="btn-read"> <a href="/2020/06/11/creating-custom-opendeck-board-variants/">Read More</a> </div> </div> </div> </div> </div> </div> <div class="single-item"> <div class="categories-post-image"> <img src="/images/blog/5900f-67627252_159582195172459_3813637260394364928_o.jpg" alt="Building DubFocus controllers"> <div class="categories-post-hover text-center"> <div class="hover-details"> <div class="post-link"> <h3> <a href="/2019/08/06/building-dubfocus-controllers/">Building DubFocus controllers</a> </h3> <div class="btn-read"> <a href="/2019/08/06/building-dubfocus-controllers/">Read More</a> </div> </div> </div> </div> </div> </div> <div class="single-item"> <div class="categories-post-image"> <div class="categories-post-hover text-center"> <div class="hover-details"> <div class="post-link"> <h3> <a href="/2019/06/21/opendeck-v4-0-0-whats-new/">OpenDeck software v4.0.0 - What's new?</a> </h3> <div class="btn-read"> <a href="/2019/06/21/opendeck-v4-0-0-whats-new/">Read More</a> </div> </div> </div> </div> </div> </div> <div class="single-item"> <div class="categories-post-image"> <img src="/images/blog/43b3a-presets_global.png" alt="OpenDeck software v3.1.0 - Presets"> <div class="categories-post-hover text-center"> <div class="hover-details"> <div class="post-link"> <h3> <a href="/2018/11/19/opendeck-sw-v3-1-0-presets/">OpenDeck software v3.1.0 - Presets</a> </h3> <div class="btn-read"> <a href="/2018/11/19/opendeck-sw-v3-1-0-presets/">Read More</a> </div> </div> </div> </div> </div> </div> </div> </div> </div> </div> </div> </div> <footer> <div class="footer-area clearfix"> <div class="container"> <div class="row"> <div class="col-lg-12"> <div class="footer-logo pb-100 pt-100 text-center"> <a href="https://shanteacontrols.com"> <img src="/images/logo_notext_inv.svg" alt="Shantea Controls"> </a> </div> </div> </div> <div class="row pb-60"> <div class="col-lg-3 col-md-6"> <div class="footer-widget"> <div class="widget-title"> <h4> About </h4> </div> <div class="widget-text"> <p>Shantea Controls Blog</p> <div class="social-link"> <ul> </ul> </div> </div> </div> </div> <div class="col-lg-3 col-md-6"> <div class="footer-widget"> <div class="widget-title"> <h4>Recent posts</h4> </div> <div class="widget-text"> <div class="r-post"> <ul> <li><a href="/2022/06/20/opendeck-boards-v3-available-now/">OpenDeck boards v3 now available </a> </li> <li><a href="/2022/04/09/opendeck-boards-v3-in-development/">OpenDeck boards v3 in development </a> </li> <li><a href="/2022/04/09/opendeck-7/">OpenDeck v7 </a> </li> <li><a href="/2021/11/23/opendeck-6-what-comes-next/">OpenDeck v6 - what comes next? </a> </li> </ul> </div> </div> </div> </div> <div class="col-lg-3 col-md-6"> <div class="footer-widget"> <div class="widget-title"> <h4> Links</h4> </div> <div class="widget-text"> <div class="widget-link"> <ul> <ul> <li><a href="/" target="_blank">Main page</a></li> <li><a href="https://youtube.com/shanteacontrols" target="_blank">YouTube</a></li> <li><a href="https://www.facebook.com/shanteacontrolsmidi" target="_blank">Facebook</a></li> <li><a href="https://github.com/shanteacontrols/OpenDeck" target="_blank">GitHub</a></li> </ul> </ul></div> </div> </div> </div> </div> <div class="row"> <div class="col"> <div class="footer-text text-center"> <p class="footer-address"> &copy; 2023 Shantea Controls | Developed by <a href="https://themeix.com">themeix</a></p> </div> </div> </div> </div> </div> </footer> <script src="/js/blog/build.js"></script> </body> </html> 