<!DOCTYPE html> <html lang="zxx"> <head> <!-- meta --> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width,initial-scale=1"> <meta name="description" content=""> <meta name="keywords" content=""> <!-- Facebook Open Graph --> <meta content="Shantea Controls" property="og:site_name"> <meta property="og:locale" content="en_US"> <meta content="OpenDeck on ARM" property="og:title"> <meta content="article" property="og:type"> <meta content="" property="og:description"> <meta content="https://shanteacontrols.com/2020/02/27/opendeck-on-arm/" property="og:url"> <meta content="stm32f4discovery.jpg" property="og:image"> <meta content="opendeck" property="article:tag"> <meta content="stm32" property="article:tag"> <meta content="announce" property="article:tag"> <meta content="2020-02-27T00:00:00+00:00" property="article:published_time"> <!-- Twitter cards --> <meta name="twitter:site" content="@"> <meta name="twitter:creator" content="@"> <meta name="twitter:title" content="OpenDeck on ARM"> <meta name="twitter:description" content=""> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:image" content="https://shanteacontrols.comstm32f4discovery.jpg"> <!-- Site Title --> <title> OpenDeck on ARM &#8226 Shantea Controls Blog </title> <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon"> <!-- gulp:css --> <link rel="stylesheet" href="/css/blog/app.css"> <!-- endgulp --> <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600" rel="stylesheet"> </head> <nav class="navbar navbar-default fixed-top"> <div class="container-fluid"> <div class="navbar-header"> <a href="/blog/blog.html"> <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" fill="currentColor" class="bi bi-house" viewBox="0 0 16 16"> <path fill-rule="evenodd" d="M2 13.5V7h1v6.5a.5.5 0 0 0 .5.5h9a.5.5 0 0 0 .5-.5V7h1v6.5a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 13.5zm11-11V6l-2-2V2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5z"/> <path fill-rule="evenodd" d="M7.293 1.5a1 1 0 0 1 1.414 0l6.647 6.646a.5.5 0 0 1-.708.708L8 2.207 1.354 8.854a.5.5 0 1 1-.708-.708L7.293 1.5z"/> </svg> </a> <a href="/pages/tags/"> <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" fill="currentColor" class="bi bi-hash" viewBox="0 0 16 16"> <path d="M8.39 12.648a1.32 1.32 0 0 0-.015.18c0 .305.21.508.5.508.266 0 .492-.172.555-.477l.554-2.703h1.204c.421 0 .617-.234.617-.547 0-.312-.188-.53-.617-.53h-.985l.516-2.524h1.265c.43 0 .618-.227.618-.547 0-.313-.188-.524-.618-.524h-1.046l.476-2.304a1.06 1.06 0 0 0 .016-.164.51.51 0 0 0-.516-.516.54.54 0 0 0-.539.43l-.523 2.554H7.617l.477-2.304c.008-.04.015-.118.015-.164a.512.512 0 0 0-.523-.516.539.539 0 0 0-.531.43L6.53 5.484H5.414c-.43 0-.617.22-.617.532 0 .312.187.539.617.539h.906l-.515 2.523H4.609c-.421 0-.609.219-.609.531 0 .313.188.547.61.547h.976l-.516 2.492c-.008.04-.015.125-.015.18 0 .305.21.508.5.508.265 0 .492-.172.554-.477l.555-2.703h2.242l-.515 2.492zm-1-6.109h2.266l-.515 2.563H6.859l.532-2.563z"/> </svg> </a>  </div> </div> </nav> <body class="post-template"> <div class="page-header grey-bg mt-5 pb-100 mb-100 pt-85 clearfix"> <div class="container"> <div class="row"> <div class="col"> <div class="author-text"> <div class="single-author-d w-100"> <div class="title"> <h2 class="mb-0 text-center">OpenDeck on ARM</h2> </div> <div class="post-meta d-flex"> <ul class="post-sp-meta list-inline mx-auto my-0"> <li class="list-inline-item"> <i class="fa fa-clock-o"></i>27 February 2020 </li> </ul> </div> </div> </div> </div> </div> </div> </div> <div class="post-content-area pb-100 clearfix"> <div class="container"> <div class="row"> <div class="col-lg-10 mx-auto"> <div class="s-post-details"> <div class="post-image mb-4"> <img class="mx-auto d-block" src="/images/blog/stm32f4discovery.jpg" alt="OpenDeck on ARM"> </div> <div class="entry-content"><p>A little over two years ago, I’ve announced that <a href="https://shanteacontrols.com/2017/12/14/opendeck-on-arduino/">OpenDeck firmware started supporting various Arduino boards</a>. It was a major milestone - the firmware design was modular enough that it could support various targets instead of just official OpenDeck board. Now, it’s time to announce another major milestone: OpenDeck can now run on 32-bit STM32 microcontrollers!</p> <h2 id="rationale">Rationale</h2> <p>You might be wondering why OpenDeck needs to support ARM when everything works fine as is. Perhaps ironically, over the last few months the target with which I had the most issues supporting it was my own official OpenDeck board. That board is based on ATmega32u4 AVR microcontroller. Let’s get over the specs of that particular MCU:</p> <ul> <li>8-bit architecture</li> <li>16MHz</li> <li>32KB flash program memory</li> <li>2.5KB SRAM</li> <li>1KB EEPROM</li> <li>10-bit A/D-converter</li> <li>USB 2.0</li> </ul> <p>Its specs are quite poor, however, it was a good choice when I first started developing OpenDeck, since Arduino Leonardo used that same MCU, and I was using Arduino Leonardo for prototyping. Over the time, as the amount of OpenDeck features grew, the memory requirements also grew. I’ve managed to mitigate this by writing more compact code when possible and by enabling more and more compiler optimizations. With each optimization, I bought myself some more memory and more time until I couldn’t optimize the code anymore so that it could fit inside the MCU. Here are the results when building the firmware I’ve released today for OpenDeck board:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AVR Memory Usage
----------------
Device: atmega32u4

Program: 28392 bytes (86.6% Full)
(.text + .data + .bootloader)

Data: 2326 bytes (90.9% Full)
(.data + .bss + .noinit)
</code></pre></div></div> <p>Program usage is a bit misleading, though, since 4kB of flash is reserved for bootloader, which brings the total memory usage to 99%. I’ve only got 280 bytes left which means it has become impossible to add any more features to the official board. On top of this, ATmega32u4 only has 1kB of EEPROM memory, which means I cannot support presets on official board since the current configuration takes almost the entire EEPROM as well.</p> <h2 id="solution">Solution</h2> <p>I could’ve solved most of these issues simply by making new OpenDeck board with another beefier AVR MCU, such as AT90USB1286. That MCU has 128kB of flash, 8kB of RAM and 4kB of EEPROM. Even though I could get along with 128kB of flash and 8kB of RAM, this MCU still has same 8-bit architecture, runs on same 16 MHz clock so it has fairly limited processing power and limited EEPROM. I don’t really need more processing power right now, but I might in the future. There’s also the issue of pricing (this thing costs about 7$) and with AVR loosing on all fronts compared to vastly more powerful ARM MCUs, it is a question for how long these MCUs are going to be available. I want my next flagship board to be based on something I can count on for the next decade. It’s still probably going to be around by then, however, OpenDeck firmware might eat the resources of that MCU as well. Therefore, the only logical choice was to move to something powerful enough that I won’t need to worry about resources for a very long time. I had some prior experience with STM32 line from ST so I’ve picked STM32F4 Discovery board to be the first supported OpenDeck target.</p> <p><img src="/images/blog/stm32f4discovery.jpg" alt=""></p> <p>This particular board has STM32F407VG MCU with the following specs:</p> <ul> <li>32 bit architecture</li> <li>168MHz clock</li> <li>1MB of flash</li> <li>192kB of RAM</li> <li>12-bit ADC</li> <li>USB</li> <li>Loads of peripherals</li> </ul> <p>Even though most modern ARM MCUs don’t have EEPROM, it can be simulated using flash memory. Because of this, I have currently dedicated 16kB of flash to virtual EEPROM on this MCU, which means that I can support many presets.</p> <p>Compared to even the most powerful AVR, this thing is a beast. The great thing about this board is that it also features on-board programmer/debugger so it’s really easy to develop on. This entire board is fairly cheap as well - less than 20$.</p> <p>Currently, most of the things work on this board:</p> <ul> <li>USB MIDI</li> <li>Virtual EEPROM</li> <li>Configuration via web interface</li> <li>I/O</li> </ul> <p>The only thing I’m missing at the moment is bootloader support which will come in the coming weeks. Other stuff works for now, but I still consider this experimental since it it has undergone limited amount of testing.</p> <p>Since I still consider this experimental, there is currently no documentation on OpenDeck wiki on how to flash this board - this will come soon hopefully. Good news is that it’s much simpler to flash this board than any other Arduino board simply because this board already has integrated programmer so no external components are needed.</p> <h2 id="the-future">The future</h2> <p>Later this year I am planning on releasing OpenDeck board v2 which will feature STM32F405 MCU. It will come most likely some time after summer. It will feature exactly the same amount of inputs and outputs as the current board. It will also have exactly the same dimensions. I have also managed to include some more stuff on it:</p> <ul> <li>I2C connector</li> <li>SPI connector</li> <li>Additional UART connector</li> </ul> <p>I want this board to support many peripherals which is why I have included these connectors.</p> <p>Every other supported board variant will be still supported, but the firmware for current OpenDeck board won’t receive any new features (other than the bug fixes) since I simply have no more memory to use as mentioned above. I am also planning on releasing OpenDeck Mega, which will have support for at least:</p> <ul> <li>128 buttons</li> <li>128 LEDs</li> <li>64 analog components</li> <li>Dual DIN MIDI connectors</li> <li>Probably some more stuff</li> </ul> <p>If anyone has some suggestions for Mega board, let me know! I get loads of requests asking for board which supports many components, so OpenDeck Mega will be the long awaited answer to that.</p> </div> <div class="inner-padding fullwidth pb-60"> <div class="post-share-icon clearfix"> <div class="tag-list"> <div class="row"> <div class="col-md-8"> <p class="float-left pr-2"><strong>Tags :</strong></p> <ul class="float-left"> <li> <a href="/tag/opendeck/blog.html"> #opendeck</a> </li> <li> <a href="/tag/stm32/blog.html"> #stm32</a> </li> <li> <a href="/tag/announce/blog.html"> #announce</a> </li> </ul> </div> <div class="col-md-4"></div> </div> </div> </div> </div> </div> <div class="categories-carousel pb-60 clearfix"> <div class="section-title"> <h3>Related Posts</h3> </div> <div class="related-post-carousel owl-carousel"> <div class="single-item"> <div class="categories-post-image"> <div class="categories-post-hover text-center"> <div class="hover-details"> <div class="post-link"> <h3> <a href="/2022/06/24/new-pco-features/">Using The New Program Change Offset Features In OpenDeck v7.3.0</a> </h3> <div class="btn-read"> <a href="/2022/06/24/new-pco-features/">Read More</a> </div> </div> </div> </div> </div> </div> <div class="single-item"> <div class="categories-post-image"> <img src="/images/blog/od3/5.png" alt="OpenDeck boards v3 now available"> <div class="categories-post-hover text-center"> <div class="hover-details"> <div class="post-link"> <h3> <a href="/2022/06/20/opendeck-boards-v3-available-now/">OpenDeck boards v3 now available</a> </h3> <div class="btn-read"> <a href="/2022/06/20/opendeck-boards-v3-available-now/">Read More</a> </div> </div> </div> </div> </div> </div> <div class="single-item"> <div class="categories-post-image"> <img src="/images/blog/od3/2.png" alt="OpenDeck boards v3 in development"> <div class="categories-post-hover text-center"> <div class="hover-details"> <div class="post-link"> <h3> <a href="/2022/04/09/opendeck-boards-v3-in-development/">OpenDeck boards v3 in development</a> </h3> <div class="btn-read"> <a href="/2022/04/09/opendeck-boards-v3-in-development/">Read More</a> </div> </div> </div> </div> </div> </div> <div class="single-item"> <div class="categories-post-image"> <img src="/images/blog/ble.png" alt="OpenDeck v7"> <div class="categories-post-hover text-center"> <div class="hover-details"> <div class="post-link"> <h3> <a href="/2022/04/09/opendeck-7/">OpenDeck v7</a> </h3> <div class="btn-read"> <a href="/2022/04/09/opendeck-7/">Read More</a> </div> </div> </div> </div> </div> </div> <div class="single-item"> <div class="categories-post-image"> <img src="/images/blog/cover_opendeck_v6.jpg" alt="OpenDeck v6 - what comes next?"> <div class="categories-post-hover text-center"> <div class="hover-details"> <div class="post-link"> <h3> <a href="/2021/11/23/opendeck-6-what-comes-next/">OpenDeck v6 - what comes next?</a> </h3> <div class="btn-read"> <a href="/2021/11/23/opendeck-6-what-comes-next/">Read More</a> </div> </div> </div> </div> </div> </div> <div class="single-item"> <div class="categories-post-image"> <img src="/images/blog/166086360_207954164335998_7262799458133236482_n.jpg" alt="Regarding DubFocus"> <div class="categories-post-hover text-center"> <div class="hover-details"> <div class="post-link"> <h3> <a href="/2021/03/30/regarding-dubfocus/">Regarding DubFocus</a> </h3> <div class="btn-read"> <a href="/2021/03/30/regarding-dubfocus/">Read More</a> </div> </div> </div> </div> </div> </div> </div> </div> </div> </div> </div> </div> <footer> <div class="footer-area clearfix"> <div class="container"> <div class="row"> <div class="col-lg-12"> <div class="footer-logo pb-100 pt-100 text-center"> <a href="https://shanteacontrols.com"> <img src="/images/logo_notext_inv.svg" alt="Shantea Controls"> </a> </div> </div> </div> <div class="row pb-60"> <div class="col-lg-3 col-md-6"> <div class="footer-widget"> <div class="widget-title"> <h4> About </h4> </div> <div class="widget-text"> <p>Shantea Controls Blog</p> <div class="social-link"> <ul> </ul> </div> </div> </div> </div> <div class="col-lg-3 col-md-6"> <div class="footer-widget"> <div class="widget-title"> <h4>Recent posts</h4> </div> <div class="widget-text"> <div class="r-post"> <ul> <li><a href="/2022/06/24/new-pco-features/">Using The New Program Change Offset Features In OpenDeck v7.3.0 </a> </li> <li><a href="/2022/06/20/opendeck-boards-v3-available-now/">OpenDeck boards v3 now available </a> </li> <li><a href="/2022/04/09/opendeck-boards-v3-in-development/">OpenDeck boards v3 in development </a> </li> <li><a href="/2022/04/09/opendeck-7/">OpenDeck v7 </a> </li> </ul> </div> </div> </div> </div> <div class="col-lg-3 col-md-6"> <div class="footer-widget"> <div class="widget-title"> <h4> Links</h4> </div> <div class="widget-text"> <div class="widget-link"> <ul> <ul> <li><a href="/" target="_blank">Main page</a></li> <li><a href="https://youtube.com/shanteacontrols" target="_blank">YouTube</a></li> <li><a href="https://www.facebook.com/shanteacontrolsmidi" target="_blank">Facebook</a></li> <li><a href="https://github.com/shanteacontrols/OpenDeck" target="_blank">GitHub</a></li> </ul> </ul></div> </div> </div> </div> </div> <div class="row"> <div class="col"> <div class="footer-text text-center"> <p class="footer-address"> &copy; 2024 Shantea Controls | Developed by <a href="https://themeix.com">themeix</a></p> </div> </div> </div> </div> </div> </footer> <script src="/js/blog/build.js"></script> </body> </html> 